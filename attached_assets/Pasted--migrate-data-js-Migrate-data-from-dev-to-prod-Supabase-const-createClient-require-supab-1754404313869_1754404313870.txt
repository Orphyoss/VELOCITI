// migrate-data.js - Migrate data from dev to prod Supabase
const { createClient } = require('@supabase/supabase-js');

// Development database (source)
const devSupabase = createClient(
  process.env.DEV_SUPABASE_URL,
  process.env.DEV_SUPABASE_ANON_KEY
);

// Production database (destination) 
const prodSupabase = createClient(
  process.env.PROD_SUPABASE_URL,
  process.env.PROD_SUPABASE_ANON_KEY
);

async function migrateData() {
  console.log('🚀 Starting data migration from dev to prod...');
  
  try {
    // 1. Get all data from development database
    console.log('📊 Fetching data from development database...');
    
    const { data: alerts, error: alertsError } = await devSupabase
      .from('alerts')
      .select('*');
    
    if (alertsError) {
      throw new Error(`Failed to fetch alerts: ${alertsError.message}`);
    }
    
    console.log(`✅ Found ${alerts?.length || 0} alerts in development`);
    
    // 2. Clear production database (optional)
    console.log('🧹 Clearing production database...');
    const { error: clearError } = await prodSupabase
      .from('alerts')
      .delete()
      .neq('id', 0); // Delete all rows
    
    if (clearError) {
      console.warn(`⚠️ Warning clearing prod data: ${clearError.message}`);
    }
    
    // 3. Insert data into production
    if (alerts && alerts.length > 0) {
      console.log('📤 Inserting data into production database...');
      
      const { data: insertedData, error: insertError } = await prodSupabase
        .from('alerts')
        .insert(alerts);
      
      if (insertError) {
        throw new Error(`Failed to insert data: ${insertError.message}`);
      }
      
      console.log(`✅ Successfully migrated ${alerts.length} alerts to production`);
    }
    
    // 4. Verify migration
    console.log('🔍 Verifying migration...');
    const { data: prodAlerts, error: verifyError } = await prodSupabase
      .from('alerts')
      .select('*');
    
    if (verifyError) {
      throw new Error(`Failed to verify migration: ${verifyError.message}`);
    }
    
    console.log(`✅ Production database now has ${prodAlerts?.length || 0} alerts`);
    console.log('🎉 Migration completed successfully!');
    
  } catch (error) {
    console.error('❌ Migration failed:', error.message);
    process.exit(1);
  }
}

// Add to package.json scripts:
// "migrate": "node migrate-data.js"

if (require.main === module) {
  migrateData();
}

module.exports = { migrateData };